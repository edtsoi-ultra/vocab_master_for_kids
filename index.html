<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spelling Master Kids - Level Up</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* HEADER */
        header {
            text-align: center;
            color: white;
            margin-bottom: 25px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        header h1 {
            font-size: 36px;
            margin-bottom: 5px;
            font-weight: 800;
            letter-spacing: 1px;
        }

        /* SCREENS */
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* LAYOUTS */
        .home-layout {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 20px;
        }

        /* SIDEBAR */
        .category-sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            height: fit-content;
            display: flex;
            flex-direction: column;
        }

        .category-title {
            font-size: 18px;
            font-weight: 800;
            color: #3f2b96;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            padding: 12px 15px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            background: #f4f6f9;
            color: #555;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            display: flex;
            justify-content: space-between;
        }

        .category-item:hover {
            background: #eef2ff;
            color: #3f2b96;
        }

        .category-item.active {
            background: #eef2ff;
            color: #3f2b96;
            border-left-color: #3f2b96;
            box-shadow: 0 2px 8px rgba(63, 43, 150, 0.15);
        }

        /* SUMMARY / REPORT SECTION */
        .summary-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .summary-header {
            font-size: 18px;
            font-weight: 800;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: #f7fafc;
            padding: 12px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-label { font-size: 11px; color: #718096; text-transform: uppercase; font-weight: 700; }
        .stat-val { font-size: 20px; font-weight: 800; color: #3f2b96; }

        .trend-bar-container {
            display: flex;
            align-items: flex-end;
            height: 60px;
            gap: 8px;
            padding-top: 10px;
            border-bottom: 1px solid #eee;
        }

        .trend-bar {
            flex: 1;
            background: #e2e8f0;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: height 0.5s;
        }
        .trend-bar.high { background: #667eea; }
        .trend-bar:hover::after {
            content: attr(data-score);
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            background: #333;
            color: white;
            padding: 2px 4px;
            border-radius: 4px;
        }

        /* MAIN CONTENT */
        .list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .list-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
        }

        .list-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .list-card h3 {
            font-size: 18px;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .list-card .meta {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
            flex-grow: 1;
        }

        /* BUTTONS */
        .btn {
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.1s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);
        }
        
        .btn-primary:hover { filter: brightness(1.1); }

        .btn-secondary { background: #e0e7ff; color: #3f2b96; }
        .btn-secondary:hover { background: #d0dbff; }

        .btn-warning { background: #fff8e1; color: #b7791f; }
        .btn-warning:hover { background: #fefcbf; }

        .btn-add {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 2px dashed #cbd5e0;
            background: transparent;
            color: #718096;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-add:hover {
            border-color: #764ba2;
            color: #764ba2;
            background: #f7fafc;
        }

        .btn-icon { padding: 8px; border-radius: 50%; width: 40px; height: 40px; }

        /* PRACTICE AREA */
        .game-container {
            max-width: 700px;
            margin: 0 auto;
        }

        .card-panel {
            background: white;
            border-radius: 24px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            position: relative;
            overflow: hidden;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .pill-container {
            display: flex;
            gap: 10px;
        }

        .progress-pill {
            background: #f0f2f5;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            color: #555;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .score-pill {
            background: #fff8e1;
            color: #f59e0b;
        }

        .timer-pill {
            background: #e6fffa;
            color: #319795;
        }

        .hint-section {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
            min-height: 40px;
        }

        .hint-text {
            font-size: 28px;
            font-weight: 800;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
            padding: 0 10px;
            transition: opacity 0.3s;
        }
        .hint-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .speak-btn {
            background: #eef2ff;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            color: #3f2b96;
            font-size: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
            transition: all 0.2s;
        }
        .speak-btn:hover { transform: scale(1.1); background: #dbe4ff; }

        /* WORD DISPLAY SYSTEM */
        .word-display-container {
            display: flex;
            flex-wrap: wrap; /* Allows wrapping of word blocks */
            justify-content: center;
            gap: 8px;
            margin: 30px 0;
            min-height: 70px;
        }

        .word-block {
            display: inline-flex;
            gap: 4px;
            margin-right: 15px; /* Replaces the visible space character */
            margin-bottom: 10px;
        }
        .word-block:last-child { margin-right: 0; }

        .char-box {
            width: 40px;
            height: 50px;
            border-bottom: 4px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: 700;
            color: #2d3748;
            font-family: monospace;
            transition: all 0.3s;
        }

        .char-box.filled {
            border-bottom-color: #3f2b96;
            color: #3f2b96;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .char-box.pre-filled {
            color: #a0aec0;
            border-bottom-color: #cbd5e0;
        }

        .char-box.vowel { border-bottom-color: #4A90E2; }
        .char-box.filled.vowel { color: #4A90E2; }
        .char-box.pre-filled.vowel { color: #90cdf4; border-bottom-color: #cbd5e0; }

        .char-box.current {
            border-bottom-color: #f59e0b;
            background: #fffbeb;
            transform: translateY(-3px);
        }

        .keyboard-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        /* Full keyboard for Level 4 */
        .keyboard-grid.full-kb {
            grid-template-columns: repeat(10, 1fr);
            gap: 4px;
        }
        .keyboard-grid.full-kb .key-btn {
            height: 45px;
            font-size: 18px;
            border-radius: 6px;
        }

        .key-btn {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            height: 60px;
            font-size: 24px;
            font-weight: 700;
            color: #4a5568;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            overflow: hidden;
            font-family: monospace;
        }

        .key-btn.vowel {
            color: #4A90E2; 
            background: #f0f7ff;
            border-color: #dbeafe;
        }

        .key-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            border-color: #cbd5e0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .key-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .key-btn.correct {
            background: #c6f6d5;
            border-color: #48bb78;
            color: #276749;
        }
        .key-btn.correct.vowel { color: #276749; }

        .key-btn.wrong {
            background: #fed7d7;
            border-color: #f56565;
            color: #c53030;
            animation: shake 0.4s;
        }

        .key-btn:disabled {
            opacity: 0.6;
            cursor: default;
            transform: none !important;
        }

        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* RESULTS SCREEN */
        .results-panel {
            text-align: center;
            padding: 40px;
        }
        
        .big-score {
            font-size: 80px;
            font-weight: 800;
            background: -webkit-linear-gradient(#667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .stars-container {
            font-size: 40px;
            margin-bottom: 20px;
            letter-spacing: 10px;
        }

        /* RECAP SECTION */
        .recap-section {
            margin-top: 20px;
            text-align: left;
            background: #fff5f5;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #fed7d7;
            display: none; /* Hidden by default */
        }

        .recap-title {
            font-size: 14px;
            font-weight: 700;
            color: #c53030;
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .recap-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .recap-item {
            background: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 18px;
            font-family: monospace;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #2d3748;
        }
        
        .recap-hint { font-size: 14px; color: #718096; font-family: sans-serif; }
        
        .char-error { color: #e53e3e; text-decoration: underline; text-decoration-color: #e53e3e; text-decoration-thickness: 3px; }

        /* MODALS */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }

        .modal-box {
            background: white;
            width: 90%;
            max-width: 500px;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: popIn 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* WORD COMPLETION OVERLAY */
        .completion-modal {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            text-align: center;
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            animation: popIn 0.4s;
            border: 4px solid #667eea;
        }
        .completion-word { font-size: 48px; font-weight: 800; color: #3f2b96; margin-bottom: 10px; line-height: 1.2; }
        .completion-hint { font-size: 32px; color: #666; font-weight: 600; }

        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #4a5568; }
        .form-input {
            width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 10px;
            font-size: 16px; margin-bottom: 15px; outline: none; transition: 0.2s;
        }
        .form-input:focus { border-color: #667eea; }
        textarea.form-input { min-height: 120px; font-family: monospace; }

        /* DIFFICULTY SELECTION STYLES */
        .diff-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .diff-card {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background: #f8fafc;
        }
        .diff-card:hover {
            border-color: #667eea;
            background: #eef2ff;
            transform: translateX(5px);
        }
        .diff-title {
            font-weight: 800;
            color: #2d3748;
            font-size: 16px;
            margin-bottom: 4px;
        }
        .diff-desc {
            font-size: 13px;
            color: #718096;
        }

        /* DATA MANAGEMENT TABS */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 2px solid #edf2f7; }
        .tab-btn {
            padding: 10px 15px; background: none; border: none; font-weight: 700; color: #718096; cursor: pointer;
            border-bottom: 3px solid transparent; margin-bottom: -2px;
        }
        .tab-btn.active { color: #3f2b96; border-bottom-color: #3f2b96; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .code-view {
            background: #2d3748; color: #a3bffa; font-family: monospace; font-size: 12px;
            padding: 15px; border-radius: 8px; width: 100%; height: 200px; overflow: auto;
            margin-bottom: 10px; border: none; resize: vertical;
        }
        .help-box {
            background: #ebf8ff; padding: 12px; border-radius: 8px; font-size: 13px; color: #2c5282; margin-bottom: 10px;
            border-left: 4px solid #4299e1;
        }

        /* CONFETTI CANVAS */
        #confetti-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 999;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .home-layout { grid-template-columns: 1fr; }
            .keyboard-grid { gap: 8px; }
            .key-btn { height: 50px; font-size: 20px; }
            header h1 { font-size: 28px; }
            .keyboard-grid.full-kb { grid-template-columns: repeat(7, 1fr); }
            .keyboard-grid.full-kb .key-btn { font-size: 14px; height: 40px; }
        }
    </style>
</head>
<body>

    <canvas id="confetti-canvas"></canvas>

    <div class="container">
        <header>
            <h1>Spelling Master</h1>
            <p>Kids Edition</p>
        </header>

        <!-- HOME SCREEN -->
        <div id="homeScreen" class="screen active">
            <div class="home-layout">
                <!-- Sidebar -->
                <div class="category-sidebar">
                    <div class="category-title">
                        Categories
                        <button class="btn-icon btn-secondary" onclick="app.showAddCategory()" title="Add Category">+</button>
                    </div>
                    <div id="categoriesList" class="category-list">
                        <!-- Categories injected here -->
                    </div>

                    <!-- New Data Button (Added from newer version) -->
                    <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #edf2f7;">
                        <button class="btn btn-secondary" style="width: 100%; font-size: 13px;" onclick="app.showDataModal()">
                            ‚öôÔ∏è Manage Data
                        </button>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="main-content">
                    
                    <!-- PROGRESS REPORT (Previous Logic) -->
                    <div class="summary-section" id="summarySection">
                        <div class="summary-header">
                            <span>üìä</span> Progress Report
                        </div>
                        <div class="stats-grid">
                            <div class="stat-box">
                                <div class="stat-label">Total Lists</div>
                                <div class="stat-val" id="statLists">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Lists Completed</div>
                                <div class="stat-val" id="statCompleted">0</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-label">Avg. Score</div>
                                <div class="stat-val" id="statAvg">0</div>
                            </div>
                        </div>
                        <div style="font-size: 11px; color: #718096; margin-bottom: 5px; font-weight: 700;">RECENT SCORES</div>
                        <div class="trend-bar-container" id="trendContainer">
                            <!-- Bars injected via JS -->
                            <div style="font-size: 12px; color: #aaa; width: 100%; text-align: center; padding-top: 15px;">Play a game to see trends!</div>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 id="currentCategoryTitle" style="color: white; font-size: 24px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);">All Lists</h2>
                        <button class="btn btn-secondary" onclick="app.showCreateList()">+ New List</button>
                    </div>

                    <div id="listsContainer" class="list-grid">
                        <!-- Lists injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PRACTICE SCREEN -->
        <div id="practiceScreen" class="screen">
            <div class="game-container">
                <button class="btn btn-secondary" style="margin-bottom: 20px;" onclick="app.backHome()">‚Üê Back Home</button>
                
                <div class="card-panel">
                    <div class="top-bar">
                        <div class="pill-container">
                            <div class="progress-pill">
                                <span>üìù</span>
                                <span id="progressText">1 / 10</span>
                            </div>
                            <div class="progress-pill timer-pill">
                                <span>‚è±Ô∏è</span>
                                <span id="timerText">0:00</span>
                            </div>
                            <div class="progress-pill" style="background: #ebf8ff; color: #2b6cb0;">
                                <span>üéì</span>
                                <span id="levelText">Level 1</span>
                            </div>
                        </div>
                        <div class="progress-pill score-pill">
                            <span>‚≠ê</span>
                            <span id="scoreText">100</span>
                        </div>
                    </div>

                    <div class="hint-section">
                        <div class="hint-text" id="hintText">Question Hint</div>
                        <button class="speak-btn" onclick="app.speakWord()" title="Listen">üîä</button>
                    </div>

                    <div class="word-display-container" id="wordDisplay">
                        <!-- Word blocks go here -->
                    </div>

                    <div id="feedbackArea" style="height: 20px; text-align: center; color: #e53e3e; font-weight: 700; margin-bottom: 10px;"></div>

                    <div class="keyboard-grid" id="keyboard">
                        <!-- Buttons go here -->
                    </div>
                    <div style="text-align: center; margin-top: 10px; font-size: 12px; color: #a0aec0;">
                        (You can also use your physical keyboard)
                    </div>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="resultsScreen" class="screen">
            <div class="game-container">
                <div class="card-panel results-panel">
                    <h2 style="color: #4a5568; margin-bottom: 20px;">Lesson Complete!</h2>
                    
                    <div class="stars-container" id="finalStars">‚≠ê‚≠ê‚≠ê</div>
                    <div class="big-score" id="finalScoreDisplay">100</div>
                    <p style="color: #718096; margin-bottom: 30px; font-weight: 600;">POINTS</p>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 30px; text-align: left;">
                        <div style="background: #f7fafc; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Correct Words</div>
                            <div style="font-size: 20px; font-weight: 700; color: #2d3748;" id="finalCorrect">10/10</div>
                        </div>
                        <div style="background: #f7fafc; padding: 15px; border-radius: 12px;">
                            <div style="font-size: 12px; color: #718096; text-transform: uppercase;">Time Taken</div>
                            <div style="font-size: 20px; font-weight: 700; color: #667eea;" id="finalTimeDisplay">0:00</div>
                        </div>
                    </div>

                    <!-- RECAP SECTION -->
                    <div id="recapSection" class="recap-section">
                        <div class="recap-title">Review Mistakes</div>
                        <div class="recap-list" id="recapList">
                            <!-- Mistakes injected here -->
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-secondary" style="flex: 1;" onclick="app.backHome()">Menu</button>
                        <button id="retryBtn" class="btn btn-primary" style="flex: 1;" onclick="app.retryList()">Play Again</button>
                    </div>
                    <!-- New Retry Mistakes Button -->
                    <div id="retryMistakesContainer" style="margin-top: 10px; display: none;">
                         <button class="btn btn-warning" style="width: 100%;" onclick="app.startMistakesSession()">‚ö†Ô∏è Retry Mistakes Only</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- WORD COMPLETION OVERLAY -->
    <div id="overlayCompletion" class="modal-overlay">
        <div class="completion-modal">
            <div class="completion-word" id="compWord">APPLE</div>
            <div class="completion-hint" id="compHint">ËòãÊûú</div>
        </div>
    </div>

    <!-- MODALS -->
    
    <!-- LEVEL SELECTION MODAL (Previous Logic) -->
    <div id="modalDifficulty" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 15px; text-align: center;">Select Difficulty</h3>
            <div class="diff-grid">
                <div class="diff-card" onclick="app.confirmStart(1)">
                    <div class="diff-title">Level 1: Beginner</div>
                    <div class="diff-desc">Fills 70% of letters. Focus on vowels. 4 Choices.</div>
                </div>
                <div class="diff-card" onclick="app.confirmStart(2)">
                    <div class="diff-title">Level 2: Intermediate</div>
                    <div class="diff-desc">Fills 20% of letters. 4 Choices.</div>
                </div>
                <div class="diff-card" onclick="app.confirmStart(3)">
                    <div class="diff-title">Level 3: Standard</div>
                    <div class="diff-desc">Fill 100%. 6 Choices. (Default)</div>
                </div>
                <div class="diff-card" onclick="app.confirmStart(4)">
                    <div class="diff-title">Level 4: Expert</div>
                    <div class="diff-desc">No Hint Text (Audio Only). Full Keyboard.</div>
                </div>
            </div>
            <button class="btn btn-secondary" style="width: 100%" onclick="app.closeModals()">Cancel</button>
        </div>
    </div>

    <!-- DATA MANAGEMENT MODAL (Added Feature) -->
    <div id="modalData" class="modal-overlay">
        <div class="modal-box">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3>Manage Data</h3>
                <button class="btn-icon" style="background:none; font-size:20px;" onclick="app.closeModals()">‚úï</button>
            </div>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="app.switchTab('tabTextImport', this)">Smart Import</button>
                <button class="tab-btn" onclick="app.switchTab('tabExport', this)">Share / Backup</button>
                <button class="tab-btn" onclick="app.switchTab('tabImport', this)">Restore JSON</button>
            </div>

            <!-- TAB 1: SMART TEXT IMPORT -->
            <div id="tabTextImport" class="tab-content active">
                <div class="help-box">
                    <strong>Instructions:</strong> Use <b>#</b> for Category and <b>##</b> for List Name.<br/>
                    Example:<br/>
                    <code># Animals</code><br/>
                    <code>## Farm</code><br/>
                    <code>Cow, Áâõ</code><br/>
                    <code>## Jungle</code><br/>
                    <code>Lion, ÁçÖÂ≠ê</code>
                </div>
                <textarea id="bulkTextInput" class="form-input" style="height: 150px;" placeholder="# My Category&#10;## My List&#10;Apple, ËòãÊûú&#10;Banana, È¶ôËïâ"></textarea>
                <button class="btn btn-primary" style="width: 100%" onclick="app.processBulkImport()">Import Text</button>
            </div>

            <!-- TAB 2: EXPORT -->
            <div id="tabExport" class="tab-content">
                <p style="margin-bottom: 10px; font-size: 14px; color: #666;">Copy this code to share your lists with another device.</p>
                <textarea id="exportJsonOutput" class="code-view" readonly></textarea>
                <button class="btn btn-primary" style="width: 100%" onclick="app.copyExportData()">Copy to Clipboard</button>
            </div>

            <!-- TAB 3: IMPORT JSON -->
            <div id="tabImport" class="tab-content">
                <p style="margin-bottom: 10px; font-size: 14px; color: #666;">Paste the code from another device here.</p>
                <textarea id="importJsonInput" class="code-view" placeholder='Paste code here...'></textarea>
                <button class="btn btn-warning" style="width: 100%" onclick="app.processJsonImport()">Restore / Merge Data</button>
            </div>
        </div>
    </div>

    <div id="modalAddCategory" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;">Add New Category</h3>
            <form onsubmit="app.handleCreateCategory(event)">
                <label class="form-label">Category Name</label>
                <input type="text" id="inputCatName" class="form-input" placeholder="e.g. My Custom Words" required>
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" style="flex:1" onclick="app.closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">Create</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modalAddList" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom: 20px;">Create New List</h3>
            <form onsubmit="app.handleCreateList(event)">
                <label class="form-label">List Name</label>
                <input type="text" id="inputListName" class="form-input" placeholder="e.g. Lesson 1" required>
                
                <label class="form-label">Category</label>
                <select id="inputListCategory" class="form-input" required></select>
                
                <label class="form-label">Words (English, Hint/Chinese)</label>
                <textarea id="inputListWords" class="form-input" placeholder="apple, ËòãÊûú&#10;banana, È¶ôËïâ" required></textarea>
                
                <div style="display: flex; gap: 10px;">
                    <button type="button" class="btn btn-secondary" style="flex:1" onclick="app.closeModals()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex:1">Save List</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // --- CONFETTI ENGINE ---
        const confetti = {
            canvas: document.getElementById('confetti-canvas'),
            ctx: document.getElementById('confetti-canvas').getContext('2d'),
            particles: [],
            isActive: false,
            init() {
                this.canvas.width = window.innerWidth;
                this.canvas.height = window.innerHeight;
                window.addEventListener('resize', () => {
                    this.canvas.width = window.innerWidth;
                    this.canvas.height = window.innerHeight;
                });
            },
            fire() {
                this.isActive = true;
                this.particles = [];
                for(let i=0; i<100; i++) {
                    this.particles.push({
                        x: window.innerWidth / 2,
                        y: window.innerHeight / 2,
                        vx: (Math.random() - 0.5) * 20,
                        vy: (Math.random() - 0.5) * 20,
                        color: `hsl(${Math.random()*360}, 100%, 50%)`,
                        life: 100
                    });
                }
                this.animate();
            },
            animate() {
                if (!this.isActive) return;
                this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
                let activeCount = 0;
                this.particles.forEach(p => {
                    if(p.life > 0) {
                        p.x += p.vx;
                        p.y += p.vy;
                        p.vy += 0.5; // gravity
                        p.life--;
                        this.ctx.fillStyle = p.color;
                        this.ctx.fillRect(p.x, p.y, 8, 8);
                        activeCount++;
                    }
                });
                if(activeCount > 0) requestAnimationFrame(() => this.animate());
                else this.isActive = false;
            }
        };
        confetti.init();

 // --- DATA ---
const P1_CURRICULUM = {
  "Week 1": {
    "words": [
      [
        "cat",
        "Ë≤ì"
      ],
      [
        "dog",
        "Áãó"
      ],
      [
        "bird",
        "È≥•"
      ],
      [
        "fish",
        "È≠ö"
      ],
      [
        "mouse",
        "Èº†"
      ],
      [
        "rabbit",
        "ÂÖî"
      ],
      [
        "pig",
        "Ë±¨"
      ],
      [
        "cow",
        "Áâõ"
      ],
      [
        "sheep",
        "Á∂øÁæä"
      ],
      [
        "horse",
        "È¶¨"
      ]
    ]
  },
  "Week 2": {
    "words": [
      [
        "apple",
        "ËòãÊûú"
      ],
      [
        "banana",
        "È¶ôËïâ"
      ],
      [
        "orange",
        "Ê©ô"
      ],
      [
        "grape",
        "Ëë°ËêÑ"
      ],
      [
        "mango",
        "ËäíÊûú"
      ],
      [
        "pear",
        "Ê¢®"
      ],
      [
        "plum",
        "Ê¢Ö"
      ],
      [
        "peach",
        "Ê°É"
      ],
      [
        "melon",
        "Áìú"
      ],
      [
        "lemon",
        "Ê™∏Ê™¨"
      ]
    ]
  },
  "Week 3": {
    "words": [
      [
        "red",
        "Á¥Ö"
      ],
      [
        "blue",
        "Ëóç"
      ],
      [
        "green",
        "Á∂†"
      ],
      [
        "yellow",
        "ÈªÉ"
      ],
      [
        "white",
        "ÁôΩ"
      ],
      [
        "black",
        "Èªë"
      ],
      [
        "pink",
        "Á≤âÁ¥Ö"
      ],
      [
        "purple",
        "Á¥´"
      ],
      [
        "brown",
        "Âï°"
      ],
      [
        "orange",
        "Ê©ô"
      ]
    ]
  },
  "Week 4": {
    "words": [
      [
        "sun",
        "Â§™ÈôΩ"
      ],
      [
        "moon",
        "Êúà‰∫Æ"
      ],
      [
        "star",
        "ÊòüÊòü"
      ],
      [
        "cloud",
        "Èõ≤"
      ],
      [
        "rain",
        "‰∏ãÈõ®"
      ],
      [
        "snow",
        "Èõ™"
      ],
      [
        "wind",
        "È¢®"
      ],
      [
        "storm",
        "Êö¥È¢®"
      ],
      [
        "hot",
        "ÁÜ±"
      ],
      [
        "cold",
        "ÂÜ∑"
      ]
    ]
  },
  "Week 5": {
    "words": [
      [
        "book",
        "Êõ∏"
      ],
      [
        "pen",
        "Á≠Ü"
      ],
      [
        "desk",
        "Êõ∏Êû±"
      ],
      [
        "chair",
        "Ê§ÖÂ≠ê"
      ],
      [
        "teacher",
        "ËÄÅÂ∏´"
      ],
      [
        "student",
        "Â≠∏Áîü"
      ],
      [
        "class",
        "Áè≠Á¥ö"
      ],
      [
        "school",
        "Â≠∏Ê†°"
      ],
      [
        "bell",
        "Èêò"
      ],
      [
        "paper",
        "Á¥ô"
      ]
    ]
  },
  "Week 6": {
    "words": [
      [
        "head",
        "È†≠"
      ],
      [
        "hair",
        "È†≠È´Æ"
      ],
      [
        "face",
        "Ëáâ"
      ],
      [
        "eye",
        "ÁúºÁùõ"
      ],
      [
        "nose",
        "ÈºªÂ≠ê"
      ],
      [
        "mouth",
        "Âò¥Â∑¥"
      ],
      [
        "ear",
        "ËÄ≥Êúµ"
      ],
      [
        "hand",
        "Êâã"
      ],
      [
        "leg",
        "ËÖø"
      ],
      [
        "foot",
        "ËÖ≥"
      ]
    ]
  },
  "Week 7": {
    "words": [
      [
        "shirt",
        "Ë•ØË°´"
      ],
      [
        "pants",
        "Ë§≤Â≠ê"
      ],
      [
        "dress",
        "ÈÄ£Ë°£Ë£ô"
      ],
      [
        "skirt",
        "Ë£ôÂ≠ê"
      ],
      [
        "shoes",
        "Èûã"
      ],
      [
        "socks",
        "Ë•™Â≠ê"
      ],
      [
        "hat",
        "Â∏ΩÂ≠ê"
      ],
      [
        "jacket",
        "Â§æÂÖã"
      ],
      [
        "coat",
        "Â§ñÂ•ó"
      ],
      [
        "tie",
        "È†òÂ∏∂"
      ]
    ]
  },
  "Week 8": {
    "words": [
      [
        "one",
        "‰∏Ä"
      ],
      [
        "two",
        "‰∫å"
      ],
      [
        "three",
        "‰∏â"
      ],
      [
        "four",
        "Âõõ"
      ],
      [
        "five",
        "‰∫î"
      ],
      [
        "six",
        "ÂÖ≠"
      ],
      [
        "seven",
        "‰∏É"
      ],
      [
        "eight",
        "ÂÖ´"
      ],
      [
        "nine",
        "‰πù"
      ],
      [
        "ten",
        "ÂçÅ"
      ]
    ]
  },
  "Week 9": {
    "words": [
      [
        "run",
        "Ë∑ë"
      ],
      [
        "walk",
        "Ëµ∞"
      ],
      [
        "jump",
        "Ë∑≥"
      ],
      [
        "sit",
        "Âùê"
      ],
      [
        "stand",
        "Á´ô"
      ],
      [
        "eat",
        "ÂêÉ"
      ],
      [
        "drink",
        "Âñù"
      ],
      [
        "sleep",
        "Áù°Ë¶∫"
      ],
      [
        "play",
        "Áé©"
      ],
      [
        "listen",
        "ËÅΩ"
      ]
    ]
  },
  "Week 10": {
    "words": [
      [
        "read",
        "ËÆÄ"
      ],
      [
        "write",
        "ÂØ´"
      ],
      [
        "draw",
        "Áï´"
      ],
      [
        "sing",
        "Âî±"
      ],
      [
        "dance",
        "Ë∑≥Ëàû"
      ],
      [
        "swim",
        "Ê∏∏Ê≥≥"
      ],
      [
        "laugh",
        "Á¨ë"
      ],
      [
        "cry",
        "Âì≠"
      ],
      [
        "smile",
        "ÂæÆÁ¨ë"
      ],
      [
        "clap",
        "ÊãçÊâã"
      ]
    ]
  },
  "Week 11": {
    "words": [
      [
        "father",
        "Áà∂Ë¶™"
      ],
      [
        "mother",
        "ÊØçË¶™"
      ],
      [
        "brother",
        "ÂÖÑÂºü"
      ],
      [
        "sister",
        "ÂßêÂ¶π"
      ],
      [
        "grandfather",
        "Á•ñÁà∂"
      ],
      [
        "grandmother",
        "Á•ñÊØç"
      ],
      [
        "uncle",
        "ÂèîÂèî"
      ],
      [
        "aunt",
        "Âß®Â™Ω"
      ],
      [
        "baby",
        "Â¨∞ÂÖí"
      ],
      [
        "family",
        "ÂÆ∂Â∫≠"
      ]
    ]
  },
  "Week 12": {
    "words": [
      [
        "home",
        "ÂÆ∂"
      ],
      [
        "house",
        "ÊàøÂ≠ê"
      ],
      [
        "room",
        "ÊàøÈñì"
      ],
      [
        "bedroom",
        "Ëá•ÂÆ§"
      ],
      [
        "kitchen",
        "ÂªöÊàø"
      ],
      [
        "bathroom",
        "Êµ¥ÂÆ§"
      ],
      [
        "living room",
        "ÂÆ¢Âª≥"
      ],
      [
        "door",
        "ÈñÄ"
      ],
      [
        "window",
        "Á™óÊà∂"
      ],
      [
        "bed",
        "Â∫ä"
      ]
    ]
  },
  "Week 13": {
    "words": [
      [
        "doll",
        "Ê¥ãÂ®ÉÂ®É"
      ],
      [
        "ball",
        "ÁêÉ"
      ],
      [
        "teddy bear",
        "Ê≥∞Ëø™ÁÜä"
      ],
      [
        "blocks",
        "Á©çÊú®"
      ],
      [
        "puzzle",
        "ÊãºÂúñ"
      ],
      [
        "toy car",
        "Áé©ÂÖ∑Ëªä"
      ],
      [
        "train",
        "ÁÅ´Ëªä"
      ],
      [
        "plane",
        "È£õÊ©ü"
      ],
      [
        "kite",
        "È¢®ÁÆè"
      ],
      [
        "skateboard",
        "ÊªëÊùø"
      ]
    ]
  },
  "Week 14": {
    "words": [
      [
        "big",
        "Â§ß"
      ],
      [
        "small",
        "Â∞è"
      ],
      [
        "tall",
        "È´ò"
      ],
      [
        "short",
        "ÁüÆ"
      ],
      [
        "long",
        "Èï∑"
      ],
      [
        "fat",
        "ËÉñ"
      ],
      [
        "thin",
        "Áò¶"
      ],
      [
        "happy",
        "Âø´Ê®Ç"
      ],
      [
        "sad",
        "ÂÇ∑ÂøÉ"
      ],
      [
        "angry",
        "ÁîüÊ∞£"
      ]
    ]
  },
  "Week 15": {
    "words": [
      [
        "good",
        "Â•Ω"
      ],
      [
        "bad",
        "Â£û"
      ],
      [
        "new",
        "Êñ∞"
      ],
      [
        "old",
        "Ëàä"
      ],
      [
        "young",
        "Âπ¥Ëºï"
      ],
      [
        "beautiful",
        "ÁæéÈ∫ó"
      ],
      [
        "ugly",
        "ÈÜú"
      ],
      [
        "clean",
        "‰πæÊ∑®"
      ],
      [
        "dirty",
        "È™ØÈ´í"
      ],
      [
        "fast",
        "Âø´"
      ]
    ]
  },
  "Week 16": {
    "words": [
      [
        "slow",
        "ÊÖ¢"
      ],
      [
        "in",
        "Âú®...Ë£°"
      ],
      [
        "on",
        "Âú®...‰∏ä"
      ],
      [
        "under",
        "Âú®...‰∏ã"
      ],
      [
        "behind",
        "Âú®...Âæå"
      ],
      [
        "in front of",
        "Âú®...Ââç"
      ],
      [
        "beside",
        "Âú®...ÊóÅ"
      ],
      [
        "between",
        "Âú®...‰πãÈñì"
      ],
      [
        "near",
        "Èù†Ëøë"
      ],
      [
        "here",
        "ÈÄôË£°"
      ]
    ]
  },
  "Week 17": {
    "words": [
      [
        "there",
        "ÈÇ£Ë£°"
      ],
      [
        "what",
        "‰ªÄÈ∫º"
      ],
      [
        "who",
        "Ë™∞"
      ],
      [
        "where",
        "Âì™Ë£°"
      ],
      [
        "when",
        "‰ªÄÈ∫ºÊôÇÂÄô"
      ],
      [
        "why",
        "ÁÇ∫‰ªÄÈ∫º"
      ],
      [
        "how",
        "ÊÄéÈ∫ºÊ®£"
      ],
      [
        "which",
        "Âì™‰∏ÄÂÄã"
      ],
      [
        "yes",
        "ÊòØ"
      ],
      [
        "no",
        "Âê¶"
      ]
    ]
  },
  "Week 18": {
    "words": [
      [
        "swimming",
        "Ê∏∏Ê≥≥"
      ],
      [
        "reading",
        "Èñ±ËÆÄ"
      ],
      [
        "drawing",
        "Áï´Áï´"
      ],
      [
        "singing",
        "Âî±Ê≠å"
      ],
      [
        "cycling",
        "È®éËá™Ë°åËªä"
      ],
      [
        "skating",
        "Ê∫úÂÜ∞"
      ],
      [
        "painting",
        "Áπ™Áï´"
      ],
      [
        "cooking",
        "ÁÉπÈ£™"
      ],
      [
        "fishing",
        "Èá£È≠ö"
      ],
      [
        "camping",
        "Èú≤Ááü"
      ]
    ]
  },
  "Week 19": {
    "words": [
      [
        "January",
        "‰∏ÄÊúà"
      ],
      [
        "February",
        "‰∫åÊúà"
      ],
      [
        "March",
        "‰∏âÊúà"
      ],
      [
        "April",
        "ÂõõÊúà"
      ],
      [
        "May",
        "‰∫îÊúà"
      ],
      [
        "June",
        "ÂÖ≠Êúà"
      ],
      [
        "July",
        "‰∏ÉÊúà"
      ],
      [
        "August",
        "ÂÖ´Êúà"
      ],
      [
        "September",
        "‰πùÊúà"
      ],
      [
        "October",
        "ÂçÅÊúà"
      ]
    ]
  },
  "Week 20": {
    "words": [
      [
        "November",
        "ÂçÅ‰∏ÄÊúà"
      ],
      [
        "December",
        "ÂçÅ‰∫åÊúà"
      ],
      [
        "slide",
        "ÊªëÊ¢Ø"
      ],
      [
        "swing",
        "Èû¶ÈüÜ"
      ],
      [
        "seesaw",
        "Ëπ∫Ëπ∫Êùø"
      ],
      [
        "bench",
        "Èï∑Âá≥"
      ],
      [
        "tree",
        "Ê®π"
      ],
      [
        "flower",
        "Ëä±"
      ],
      [
        "grass",
        "Ëçâ"
      ],
      [
        "playground",
        "ÈÅäÊ®ÇÂ†¥"
      ]
    ]
  },
  "Week 21": {
    "words": [
      [
        "bread",
        "È∫µÂåÖ"
      ],
      [
        "rice",
        "Á±≥È£Ø"
      ],
      [
        "noodles",
        "È∫µÊ¢ù"
      ],
      [
        "egg",
        "ÈõûËõã"
      ],
      [
        "chicken",
        "ÈõûËÇâ"
      ],
      [
        "fish",
        "È≠öËÇâ"
      ],
      [
        "vegetables",
        "Ëî¨Ëèú"
      ],
      [
        "carrot",
        "ËÉ°ËòøËîî"
      ],
      [
        "tomato",
        "Áï™ËåÑ"
      ],
      [
        "potato",
        "È¶¨Èà¥ËñØ"
      ]
    ]
  },
  "Week 22": {
    "words": [
      [
        "cake",
        "ËõãÁ≥ï"
      ],
      [
        "cookie",
        "Êõ≤Â•á"
      ],
      [
        "candy",
        "Á≥ñÊûú"
      ],
      [
        "chocolate",
        "Â∑ßÂÖãÂäõ"
      ],
      [
        "ice cream",
        "Èõ™Á≥ï"
      ],
      [
        "water",
        "Ê∞¥"
      ],
      [
        "milk",
        "ÁâõÂ•∂"
      ],
      [
        "juice",
        "ÊûúÊ±Å"
      ],
      [
        "tea",
        "Ëå∂"
      ],
      [
        "coffee",
        "ÂíñÂï°"
      ]
    ]
  },
  "Week 23": {
    "words": [
      [
        "strawberry",
        "ËçâËéì"
      ],
      [
        "watermelon",
        "Ë•øÁìú"
      ],
      [
        "pineapple",
        "Ëè†Ëòø"
      ],
      [
        "duck",
        "È¥®"
      ],
      [
        "chicken",
        "Èõû"
      ],
      [
        "monkey",
        "Áå¥Â≠ê"
      ],
      [
        "elephant",
        "Â§ßË±°"
      ],
      [
        "lion",
        "ÁçÖÂ≠ê"
      ],
      [
        "tiger",
        "ËÄÅËôé"
      ],
      [
        "bear",
        "ÁÜä"
      ]
    ]
  },
  "Week 24": {
    "words": [
      [
        "panda",
        "ÁÜäË≤ì"
      ],
      [
        "ant",
        "ËûûËüª"
      ],
      [
        "bee",
        "ËúúËúÇ"
      ],
      [
        "butterfly",
        "Ëù¥Ëù∂"
      ],
      [
        "frog",
        "ÈùíËõô"
      ],
      [
        "spider",
        "ËúòËõõ"
      ],
      [
        "hamster",
        "ÂÄâÈº†"
      ],
      [
        "turtle",
        "ÁÉèÈæú"
      ],
      [
        "rabbit",
        "ÂÖîÂ≠ê"
      ],
      [
        "goat",
        "Â±±Áæä"
      ]
    ]
  },
  "Week 25": {
    "words": [
      [
        "pencil",
        "ÈâõÁ≠Ü"
      ],
      [
        "eraser",
        "Ê©°ÁöÆÊì¶"
      ],
      [
        "ruler",
        "Â∞∫"
      ],
      [
        "marker",
        "È∫•ÂÖãÁ≠Ü"
      ],
      [
        "crayon",
        "Ë†üÁ≠Ü"
      ],
      [
        "notebook",
        "Á≠ÜË®òÊú¨"
      ],
      [
        "pencil case",
        "Á≠ÜË¢ã"
      ],
      [
        "schoolbag",
        "Êõ∏ÂåÖ"
      ],
      [
        "classroom",
        "Ë™≤ÂÆ§"
      ],
      [
        "blackboard",
        "ÈªëÊùø"
      ]
    ]
  },
  "Week 26": {
    "words": [
      [
        "whiteboard",
        "ÁôΩÊùø"
      ],
      [
        "scissors",
        "Ââ™ÂàÄ"
      ],
      [
        "glue",
        "ËÜ†Ê∞¥"
      ],
      [
        "tape",
        "ËÜ†Â∏∂"
      ],
      [
        "table",
        "Ê°åÂ≠ê"
      ],
      [
        "sofa",
        "Ê≤ôÁôº"
      ],
      [
        "TV",
        "ÈõªË¶ñ"
      ],
      [
        "fridge",
        "Èõ™Ê´É"
      ],
      [
        "lamp",
        "Ááà"
      ],
      [
        "clock",
        "ÊôÇÈêò"
      ]
    ]
  },
  "Week 27": {
    "words": [
      [
        "mirror",
        "Èè°Â≠ê"
      ],
      [
        "pillow",
        "ÊûïÈ†≠"
      ],
      [
        "blanket",
        "ÊØõÊØØ"
      ],
      [
        "towel",
        "ÊØõÂ∑æ"
      ],
      [
        "soap",
        "ËÇ•ÁöÇ"
      ],
      [
        "toothbrush",
        "ÁâôÂà∑"
      ],
      [
        "toothpaste",
        "ÁâôËÜè"
      ],
      [
        "comb",
        "Ê¢≥Â≠ê"
      ],
      [
        "hairbrush",
        "È´ÆÂà∑"
      ],
      [
        "shampoo",
        "Ê¥óÈ´ÆÊ∞¥"
      ]
    ]
  },
  "Week 28": {
    "words": [
      [
        "tooth",
        "ÁâôÈΩí"
      ],
      [
        "teeth",
        "ÁâôÈΩí(Ë§áÊï∏)"
      ],
      [
        "neck",
        "ËÑñÂ≠ê"
      ],
      [
        "shoulder",
        "ËÇ©ËÜÄ"
      ],
      [
        "arm",
        "ÊâãËáÇ"
      ],
      [
        "finger",
        "ÊâãÊåá"
      ],
      [
        "thumb",
        "ÊãáÊåá"
      ],
      [
        "knee",
        "ËÜùËìã"
      ],
      [
        "feet",
        "ËÖ≥(Ë§áÊï∏)"
      ],
      [
        "toe",
        "ËÖ≥Ë∂æ"
      ]
    ]
  },
  "Week 29": {
    "words": [
      [
        "chest",
        "ËÉ∏"
      ],
      [
        "back",
        "ËÉå"
      ],
      [
        "stomach",
        "ËÇöÂ≠ê"
      ],
      [
        "sweater",
        "ÊØõË°£"
      ],
      [
        "scarf",
        "ÂúçÂ∑æ"
      ],
      [
        "gloves",
        "ÊâãÂ•ó"
      ],
      [
        "belt",
        "ËÖ∞Â∏∂"
      ],
      [
        "uniform",
        "Âà∂Êúç"
      ],
      [
        "slippers",
        "ÊãñÈûã"
      ],
      [
        "T-shirt",
        "TÊÅ§"
      ]
    ]
  },
  "Week 30": {
    "words": [
      [
        "jeans",
        "Áâõ‰ªîË§≤"
      ],
      [
        "shorts",
        "Áü≠Ë§≤"
      ],
      [
        "cap",
        "È¥®ËàåÂ∏Ω"
      ],
      [
        "eleven",
        "ÂçÅ‰∏Ä"
      ],
      [
        "twelve",
        "ÂçÅ‰∫å"
      ],
      [
        "thirteen",
        "ÂçÅ‰∏â"
      ],
      [
        "fourteen",
        "ÂçÅÂõõ"
      ],
      [
        "fifteen",
        "ÂçÅ‰∫î"
      ],
      [
        "sixteen",
        "ÂçÅÂÖ≠"
      ],
      [
        "seventeen",
        "ÂçÅ‰∏É"
      ]
    ]
  },
  "Week 31": {
    "words": [
      [
        "eighteen",
        "ÂçÅÂÖ´"
      ],
      [
        "nineteen",
        "ÂçÅ‰πù"
      ],
      [
        "twenty",
        "‰∫åÂçÅ"
      ],
      [
        "wave",
        "ÊèÆÊâã"
      ],
      [
        "open",
        "ÊâìÈñã"
      ],
      [
        "close",
        "ÈóúÈñâ"
      ],
      [
        "speak",
        "Ë™™"
      ],
      [
        "talk",
        "Ë´áË©±"
      ],
      [
        "look",
        "Áúã"
      ],
      [
        "sky",
        "Â§©Á©∫"
      ]
    ]
  },
  "Week 32": {
    "words": [
      [
        "sunny",
        "Êô¥Â§©"
      ],
      [
        "cloudy",
        "Â§öÈõ≤"
      ],
      [
        "rainy",
        "‰∏ãÈõ®"
      ],
      [
        "windy",
        "ÊúâÈ¢®"
      ],
      [
        "warm",
        "ÊöñÂíå"
      ],
      [
        "cool",
        "Ê∂ºÁàΩ"
      ],
      [
        "rainbow",
        "ÂΩ©Ëôπ"
      ],
      [
        "thunder",
        "ÊâìÈõ∑"
      ],
      [
        "lightning",
        "ÈñÉÈõª"
      ],
      [
        "fog",
        "Èúß"
      ]
    ]
  },
  "Week 33": {
    "words": [
      [
        "path",
        "Â∞èË∑Ø"
      ],
      [
        "pond",
        "Ê±†Â°ò"
      ],
      [
        "sandbox",
        "Ê≤ôÊ±†"
      ],
      [
        "monkey bars",
        "ÊîÄÁà¨Êû∂"
      ],
      [
        "boxing",
        "Êã≥Êìä"
      ],
      [
        "hiking",
        "ÈÅ†Ë∂≥"
      ],
      [
        "row boat",
        "ÂàíËàπ"
      ],
      [
        "sailboat",
        "Â∏ÜËàπ"
      ],
      [
        "skateboard",
        "ÊªëÊùø"
      ],
      [
        "scooter",
        "ÊªëÊùøËªä"
      ]
    ]
  },
  "Week 34": {
    "words": [
      [
        "gold",
        "ÈáëËâ≤"
      ],
      [
        "silver",
        "ÈäÄËâ≤"
      ],
      [
        "grey",
        "ÁÅ∞Ëâ≤"
      ],
      [
        "strawberry",
        "ËçâËéì"
      ],
      [
        "blueberry",
        "ËóçËéì"
      ],
      [
        "raspberry",
        "Ê®πËéì"
      ],
      [
        "blackberry",
        "ÈªëËéì"
      ],
      [
        "cherry",
        "Ê´ªÊ°É"
      ],
      [
        "coconut",
        "Ê§∞Â≠ê"
      ],
      [
        "papaya",
        "Êú®Áìú"
      ]
    ]
  },
  "Week 35": {
    "words": [
      [
        "guava",
        "Áï™Áü≥Ê¶¥"
      ],
      [
        "kiwi",
        "Â•áÁï∞Êûú"
      ],
      [
        "persimmon",
        "ÊüøÂ≠ê"
      ],
      [
        "pomegranate",
        "Áü≥Ê¶¥"
      ],
      [
        "fig",
        "ÁÑ°Ëä±Êûú"
      ],
      [
        "avocado",
        "ÁâõÊ≤πÊûú"
      ],
      [
        "olive",
        "Ê©ÑÊ¨ñ"
      ],
      [
        "walnut",
        "Ê†∏Ê°É"
      ],
      [
        "almond",
        "Êùè‰ªÅ"
      ],
      [
        "peanut",
        "Ëä±Áîü"
      ]
    ]
  },
  "Week 36": {
    "words": [
      [
        "cheese",
        "ËäùÂ£´"
      ],
      [
        "butter",
        "ÈªÉÊ≤π"
      ],
      [
        "yogurt",
        "ÈÖ∏Â•∂"
      ],
      [
        "honey",
        "ËúÇËúú"
      ],
      [
        "jam",
        "ÊûúÈÜ¨"
      ],
      [
        "peanut butter",
        "Ëä±ÁîüÈÜ¨"
      ],
      [
        "oil",
        "Ê≤π"
      ],
      [
        "salt",
        "ÈπΩ"
      ],
      [
        "sugar",
        "Á≥ñ"
      ],
      [
        "spice",
        "È¶ôÊñô"
      ]
    ]
  },
  "Week 37": {
    "words": [
      [
        "fork",
        "ÂèâÂ≠ê"
      ],
      [
        "spoon",
        "Âã∫Â≠ê"
      ],
      [
        "knife",
        "ÂàÄ"
      ],
      [
        "plate",
        "Áõ§Â≠ê"
      ],
      [
        "bowl",
        "Á¢ó"
      ],
      [
        "cup",
        "ÊùØÂ≠ê"
      ],
      [
        "glass",
        "ÁéªÁíÉÊùØ"
      ],
      [
        "bottle",
        "Áì∂Â≠ê"
      ],
      [
        "napkin",
        "È§êÂ∑æ"
      ],
      [
        "tablecloth",
        "Ê°åÂ∏É"
      ]
    ]
  },
  "Week 38": {
    "words": [
      [
        "garden",
        "Ëä±Âúí"
      ],
      [
        "plant",
        "Ê§çÁâ©"
      ],
      [
        "leaf",
        "ËëâÂ≠ê"
      ],
      [
        "stem",
        "Ëéñ"
      ],
      [
        "root",
        "Ê†π"
      ],
      [
        "seed",
        "Á®ÆÂ≠ê"
      ],
      [
        "flower",
        "Ëä±"
      ],
      [
        "bush",
        "ÁÅåÊú®"
      ],
      [
        "cactus",
        "‰ªô‰∫∫Êéå"
      ],
      [
        "bamboo",
        "Á´πÂ≠ê"
      ]
    ]
  },
  "Week 39": {
    "words": [
      [
        "sunrise",
        "Êó•Âá∫"
      ],
      [
        "sunset",
        "Êó•ËêΩ"
      ],
      [
        "dawn",
        "ÈªéÊòé"
      ],
      [
        "dusk",
        "ÈªÉÊòè"
      ],
      [
        "midnight",
        "ÂçàÂ§ú"
      ],
      [
        "afternoon",
        "‰∏ãÂçà"
      ],
      [
        "morning",
        "Êó©‰∏ä"
      ],
      [
        "evening",
        "Êôö‰∏ä"
      ],
      [
        "night",
        "Êôö‰∏ä"
      ],
      [
        "day",
        "ÁôΩÂ§©"
      ]
    ]
  },
  "Week 40": {
    "words": [
      [
        "autumn",
        "ÁßãÂ§©"
      ],
      [
        "summer",
        "Â§èÂ§©"
      ],
      [
        "spring",
        "Êò•Â§©"
      ],
      [
        "winter",
        "ÂÜ¨Â§©"
      ],
      [
        "season",
        "Â≠£ÁØÄ"
      ],
      [
        "weather",
        "Â§©Ê∞£"
      ],
      [
        "climate",
        "Ê∞£ÂÄô"
      ],
      [
        "temperature",
        "Ê∫´Â∫¶"
      ],
      [
        "degree",
        "Â∫¶Êï∏"
      ],
      [
        "forecast",
        "È†êÂ†±"
      ]
    ]
  }
};


        const app = {
            // State
            wordLists: [],
            records: [], // { date, score, listId }
            customCategories: [],
            selectedCategory: 'all',
            
            // Game State
            activeList: null,
            currentWordIdx: 0,
            currentWord: null,
            targetString: null, // No spaces version for logic
            charIndex: 0,
            preFilledIndices: new Set(),
            score: 100,
            errors: 0,
            currentDifficulty: 3, // Default Level 3
            
            // Stats Tracking
            sessionStartTime: 0,
            timerInterval: null,
            currentWordErrors: new Set(), // Set of indices where errors occurred for current word
            sessionMistakes: [], // Array of { word, hint, errorIndices }
            isRetryMode: false,
            
            init() {
                this.loadData();
                this.renderHome();
                this.renderSummary(); // Render Report
                
                // Global Keyboard Listener (Preserved from preferred version)
                window.addEventListener('keydown', (e) => {
                    if (document.getElementById('practiceScreen').classList.contains('active')) {
                        const key = e.key.toLowerCase();
                        if (/^[a-z]$/.test(key)) {
                            const btns = document.querySelectorAll('.key-btn');
                            let matchedBtn = null;
                            btns.forEach(b => {
                                if (b.textContent === key && !b.disabled) matchedBtn = b;
                            });

                            if (this.currentDifficulty === 4) {
                                // For Level 4, simulate click or find button
                                if (matchedBtn) matchedBtn.click();
                            } else {
                                // For L1-L3, only accept if it's one of the options on screen
                                if (matchedBtn) matchedBtn.click();
                            }
                        }
                    }
                });
            },

            loadData() {
                // 1. Categories
                const savedCats = localStorage.getItem('customCategories');
                this.customCategories = savedCats ? JSON.parse(savedCats) : ['P1 Hong Kong'];

                // 2. Records (for report)
                const savedRecs = localStorage.getItem('records');
                this.records = savedRecs ? JSON.parse(savedRecs) : [];

                // 3. Lists
                const savedLists = localStorage.getItem('wordLists');
                let userLists = [];
                if (savedLists) {
                    try {
                        userLists = JSON.parse(savedLists).filter(l => l.category !== 'P1 Hong Kong');
                    } catch(e) {}
                }

                // 4. Defaults
                const defaultLists = [];
                for (const [week, data] of Object.entries(P1_CURRICULUM)) {
                    defaultLists.push({
                        id: 'def_' + week.replace(/\s/g, ''),
                        name: week,
                        category: "P1 Hong Kong",
                        words: data.words.map(w => ({ en: w[0], hint: w[1] }))
                    });
                }

                this.wordLists = [...defaultLists, ...userLists];
            },

            saveData() {
                const userLists = this.wordLists.filter(l => l.category !== 'P1 Hong Kong');
                localStorage.setItem('wordLists', JSON.stringify(userLists));
                localStorage.setItem('customCategories', JSON.stringify(this.customCategories));
                localStorage.setItem('records', JSON.stringify(this.records));
            },

            // --- REPORT & SUMMARY (Preserved) ---
            renderSummary() {
                document.getElementById('statLists').textContent = this.wordLists.length;
                document.getElementById('statCompleted').textContent = this.records.length;

                const avg = this.records.length > 0 
                    ? Math.round(this.records.reduce((a,b) => a + b.score, 0) / this.records.length) 
                    : 0;
                document.getElementById('statAvg').textContent = avg;

                const container = document.getElementById('trendContainer');
                container.innerHTML = '';
                const last5 = this.records.slice(-5);
                
                if (last5.length === 0) {
                     container.innerHTML = '<div style="font-size: 12px; color: #aaa; width: 100%; text-align: center; padding-top: 15px;">Play a game to see trends!</div>';
                } else {
                    last5.forEach(rec => {
                        const bar = document.createElement('div');
                        bar.className = 'trend-bar';
                        const h = Math.max(10, rec.score);
                        bar.style.height = h + '%';
                        bar.setAttribute('data-score', rec.score);
                        if (rec.score >= 80) bar.classList.add('high');
                        container.appendChild(bar);
                    });
                }
            },

            // --- NAVIGATION ---
            renderHome() {
                const catListEl = document.getElementById('categoriesList');
                catListEl.innerHTML = '';

                const allEl = document.createElement('div');
                allEl.className = `category-item ${this.selectedCategory === 'all' ? 'active' : ''}`;
                allEl.textContent = 'All Categories';
                allEl.onclick = () => this.selectCategory('all');
                catListEl.appendChild(allEl);

                const usedCats = new Set(this.wordLists.map(l => l.category));
                const allCats = new Set([...this.customCategories, ...usedCats]);

                allCats.forEach(cat => {
                    const el = document.createElement('div');
                    el.className = `category-item ${this.selectedCategory === cat ? 'active' : ''}`;
                    el.innerHTML = `<span>${cat}</span>`;
                    el.onclick = () => this.selectCategory(cat);
                    catListEl.appendChild(el);
                });

                document.getElementById('currentCategoryTitle').textContent = this.selectedCategory === 'all' ? 'All Lists' : this.selectedCategory;

                const gridEl = document.getElementById('listsContainer');
                gridEl.innerHTML = '';
                
                const filteredLists = this.selectedCategory === 'all' 
                    ? this.wordLists 
                    : this.wordLists.filter(l => l.category === this.selectedCategory);

                if (filteredLists.length === 0) {
                    gridEl.innerHTML = `<div style="grid-column: 1/-1; text-align: center; color: #888; padding: 40px;">No lists found. Create one!</div>`;
                } else {
                    filteredLists.forEach((list, idx) => {
                        const globalIdx = this.wordLists.indexOf(list);
                        const card = document.createElement('div');
                        card.className = 'list-card';
                        card.innerHTML = `
                            <h3>${list.name}</h3>
                            <div class="meta">${list.category} ‚Ä¢ ${list.words.length} words</div>
                            <button class="btn btn-primary" onclick="app.startGame(${globalIdx})">Play</button>
                        `;
                        gridEl.appendChild(card);
                    });
                }
            },

            selectCategory(cat) {
                this.selectedCategory = cat;
                this.renderHome();
            },

            showScreen(id) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(id).classList.add('active');
            },

            // --- GAME LOGIC (Restored Exactly) ---
            startGame(listIdx) {
                this.activeList = this.wordLists[listIdx];
                this.isRetryMode = false;
                document.getElementById('modalDifficulty').classList.add('active');
            },
            
            confirmStart(level) {
                this.currentDifficulty = level;
                this.closeModals();
                this.initGameSession();
            },

            startMistakesSession() {
                if (this.sessionMistakes.length === 0) return;
                const mistakeWords = this.sessionMistakes.map(m => ({ en: m.word, hint: m.hint }));
                this.activeList = {
                    id: 'temp_retry',
                    name: 'Mistakes Review',
                    words: mistakeWords
                };
                this.isRetryMode = true;
                this.initGameSession();
            },

            initGameSession() {
                this.currentWordIdx = 0;
                this.score = 100;
                this.errors = 0;
                this.sessionMistakes = [];
                
                this.sessionStartTime = Date.now();
                if (this.timerInterval) clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => this.updateTimer(), 1000);
                this.updateTimer();

                const levels = ["", "Level 1", "Level 2", "Level 3", "Level 4"];
                document.getElementById('levelText').textContent = levels[this.currentDifficulty] || "Level 3";

                this.showScreen('practiceScreen');
                this.loadQuestion();
            },

            updateTimer() {
                const diff = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                const mins = Math.floor(diff / 60);
                const secs = diff % 60;
                document.getElementById('timerText').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            },

            loadQuestion() {
                if (this.currentWordIdx >= this.activeList.words.length) {
                    this.showResults();
                    return;
                }

                const q = this.activeList.words[this.currentWordIdx];
                this.currentWord = q.en.toLowerCase(); 
                this.targetString = this.currentWord.replace(/\s+/g, '');
                this.charIndex = 0; 
                this.currentWordErrors = new Set();
                this.preFilledIndices = new Set();

                document.getElementById('progressText').textContent = `${this.currentWordIdx + 1} / ${this.activeList.words.length}`;
                document.getElementById('scoreText').textContent = this.score;
                
                // Difficulty Specific UI
                const hintEl = document.getElementById('hintText');
                hintEl.textContent = q.hint;
                if (this.currentDifficulty === 4) {
                    hintEl.classList.add('hint-hidden');
                } else {
                    hintEl.classList.remove('hint-hidden');
                }
                
                document.getElementById('feedbackArea').textContent = '';

                // PRE-FILL LOGIC (Restored Level 1-4 logic)
                const len = this.targetString.length;
                let indices = Array.from({length: len}, (_, i) => i);
                let holesNeeded = 0;

                if (this.currentDifficulty === 1) {
                    holesNeeded = Math.max(1, Math.round(len * 0.3));
                    const vowelIndices = indices.filter(i => 'aeiou'.includes(this.targetString[i]));
                    const constIndices = indices.filter(i => !'aeiou'.includes(this.targetString[i]));
                    
                    let holes = [];
                    holes = [...vowelIndices]; 
                    if (holes.length > holesNeeded) {
                        holes = holes.sort(() => 0.5 - Math.random()).slice(0, holesNeeded);
                    } else {
                        const remaining = holesNeeded - holes.length;
                        const extra = constIndices.sort(() => 0.5 - Math.random()).slice(0, remaining);
                        holes = [...holes, ...extra];
                    }
                    
                    const holesSet = new Set(holes);
                    indices.forEach(i => {
                        if (!holesSet.has(i)) this.preFilledIndices.add(i);
                    });

                } else if (this.currentDifficulty === 2) {
                    holesNeeded = Math.max(1, Math.round(len * 0.8));
                    const preFillCount = len - holesNeeded;
                    const toFill = indices.sort(() => 0.5 - Math.random()).slice(0, preFillCount);
                    toFill.forEach(i => this.preFilledIndices.add(i));
                }
                // Levels 3 & 4 have 0% prefilled (standard)

                // Render Char Boxes
                const display = document.getElementById('wordDisplay');
                display.innerHTML = '';
                
                let logicIdx = 0;
                const parts = this.currentWord.split(' ');
                
                parts.forEach((part) => {
                    const block = document.createElement('div');
                    block.className = 'word-block';
                    
                    for (let char of part) {
                        const box = document.createElement('div');
                        box.className = 'char-box';
                        if ('aeiou'.includes(char)) box.classList.add('vowel');
                        
                        if (this.preFilledIndices.has(logicIdx)) {
                            box.classList.add('filled', 'pre-filled');
                            box.textContent = char;
                        }
                        
                        block.appendChild(box);
                        logicIdx++;
                    }
                    display.appendChild(block);
                });

                setTimeout(() => this.speakWord(), 300);
                this.processNextChar();
            },

            processNextChar() {
                while (this.charIndex < this.targetString.length && this.preFilledIndices.has(this.charIndex)) {
                    this.charIndex++;
                }

                if (this.charIndex >= this.targetString.length) {
                    this.showCompletionAnimation();
                    return;
                }

                const boxes = document.querySelectorAll('.char-box');
                boxes.forEach(b => b.classList.remove('current'));
                
                if (boxes[this.charIndex]) {
                    boxes[this.charIndex].classList.add('current');
                }

                this.generateButtons();
            },

            showCompletionAnimation() {
                if (this.currentWordErrors.size > 0) {
                    this.sessionMistakes.push({
                        word: this.activeList.words[this.currentWordIdx].en,
                        hint: this.activeList.words[this.currentWordIdx].hint,
                        errorIndices: new Set(this.currentWordErrors)
                    });
                }

                const q = this.activeList.words[this.currentWordIdx];
                document.getElementById('compWord').textContent = q.en.toUpperCase();
                document.getElementById('compHint').textContent = q.hint;
                
                const overlay = document.getElementById('overlayCompletion');
                overlay.classList.add('active');

                this.speakWord();

                setTimeout(() => {
                    overlay.classList.remove('active');
                    this.currentWordIdx++;
                    this.loadQuestion();
                }, 1500);
            },

            generateButtons() {
                const targetChar = this.targetString[this.charIndex];
                const grid = document.getElementById('keyboard');
                grid.innerHTML = ''; 
                grid.className = 'keyboard-grid'; 

                if (this.currentDifficulty === 4) {
                    // FULL KEYBOARD for Level 4
                    grid.classList.add('full-kb');
                    const qwerty = "qwertyuiopasdfghjklzxcvbnm";
                    for(let char of qwerty) {
                        const btn = document.createElement('button');
                        btn.className = 'key-btn';
                        btn.textContent = char;
                        btn.onclick = () => this.handleInput(char, btn, targetChar);
                        grid.appendChild(btn);
                    }
                } else {
                    // RESTRICTED OPTIONS for Levels 1-3
                    grid.classList.remove('full-kb');
                    
                    const options = new Set([targetChar]);
                    const alphabet = 'abcdefghijklmnopqrstuvwxyz';
                    
                    if (Math.random() > 0.5) options.add('a');
                    if (Math.random() > 0.5) options.add('e');

                    // L1/L2: 4 choices, L3: 6 choices
                    const numChoices = (this.currentDifficulty === 1 || this.currentDifficulty === 2) ? 4 : 6;

                    while(options.size < numChoices) {
                        options.add(alphabet[Math.floor(Math.random() * alphabet.length)]);
                    }

                    const buttonsArr = Array.from(options).sort(() => Math.random() - 0.5);

                    buttonsArr.forEach(char => {
                        const btn = document.createElement('button');
                        btn.className = 'key-btn';
                        btn.textContent = char;
                        if ('aeiou'.includes(char)) btn.classList.add('vowel');
                        btn.onclick = () => this.handleInput(char, btn, targetChar);
                        grid.appendChild(btn);
                    });
                }
            },

            handleInput(char, btn, target) {
                const allBtns = document.querySelectorAll('.key-btn');
                
                if (char === target) {
                    btn.classList.add('correct');
                    allBtns.forEach(b => b.disabled = true);
                    
                    const boxes = document.querySelectorAll('.char-box');
                    boxes[this.charIndex].textContent = char;
                    boxes[this.charIndex].classList.add('filled');
                    boxes[this.charIndex].classList.remove('current');

                    this.charIndex++;
                    const delay = this.currentDifficulty === 4 ? 150 : 300;
                    setTimeout(() => this.processNextChar(), delay);
                } else {
                    btn.classList.add('wrong');
                    btn.disabled = true; 
                    this.errors++;
                    this.currentWordErrors.add(this.charIndex); 
                    
                    this.score = Math.max(0, this.score - 2);
                    document.getElementById('scoreText').textContent = this.score;
                    
                    const boxes = document.querySelectorAll('.char-box');
                    if (boxes[this.charIndex]) {
                        boxes[this.charIndex].animate([
                            { transform: 'translateX(0)' },
                            { transform: 'translateX(-5px)' },
                            { transform: 'translateX(5px)' },
                            { transform: 'translateX(0)' }
                        ], { duration: 300 });
                    }
                }
            },

            speakWord() {
                if ('speechSynthesis' in window) {
                    window.speechSynthesis.cancel();
                    const utterance = new SpeechSynthesisUtterance(this.currentWord);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.9;
                    window.speechSynthesis.speak(utterance);
                }
            },

            // --- RESULTS (Restored) ---
            showResults() {
                clearInterval(this.timerInterval);
                this.showScreen('resultsScreen');
                
                const finalScore = Math.max(20, this.score);
                
                if (!this.isRetryMode) {
                    this.records.push({
                        date: Date.now(),
                        score: finalScore,
                        listId: this.activeList.id
                    });
                    this.saveData();
                    this.renderSummary(); 
                }

                document.getElementById('finalScoreDisplay').textContent = finalScore;
                document.getElementById('finalCorrect').textContent = `${this.activeList.words.length}/${this.activeList.words.length}`;
                document.getElementById('finalTimeDisplay').textContent = document.getElementById('timerText').textContent;

                let stars = '‚≠ê';
                if (finalScore > 60) stars += '‚≠ê';
                if (finalScore > 90) stars += '‚≠ê';
                document.getElementById('finalStars').textContent = stars;

                // RECAP
                const recapEl = document.getElementById('recapSection');
                const listEl = document.getElementById('recapList');
                listEl.innerHTML = '';
                const retryMistakesBtn = document.getElementById('retryMistakesContainer');

                if (this.sessionMistakes.length > 0) {
                    recapEl.style.display = 'block';
                    retryMistakesBtn.style.display = 'block';

                    this.sessionMistakes.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'recap-item';
                        
                        let htmlWord = '';
                        let logicIdx = 0;
                        for(let i=0; i<item.word.length; i++) {
                            const char = item.word[i];
                            if (char === ' ') {
                                htmlWord += ' ';
                            } else {
                                if (item.errorIndices.has(logicIdx)) {
                                    htmlWord += `<span class="char-error">${char}</span>`;
                                } else {
                                    htmlWord += char;
                                }
                                logicIdx++;
                            }
                        }

                        div.innerHTML = `
                            <div>${htmlWord}</div>
                            <div class="recap-hint">${item.hint}</div>
                        `;
                        listEl.appendChild(div);
                    });
                } else {
                    recapEl.style.display = 'none';
                    retryMistakesBtn.style.display = 'none';
                }

                if (finalScore >= 80) confetti.fire();
            },

            retryList() {
                if (this.isRetryMode) {
                    this.backHome(); 
                } else {
                    this.startGame(this.wordLists.indexOf(this.activeList));
                }
            },

            backHome() {
                this.showScreen('homeScreen');
            },

            // --- DATA & MODAL HANDLERS ---
            showAddCategory() { document.getElementById('modalAddCategory').classList.add('active'); },
            showCreateList() {
                const select = document.getElementById('inputListCategory');
                select.innerHTML = '';
                const cats = new Set([...this.customCategories, ...this.wordLists.map(l=>l.category)]);
                cats.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c;
                    if (c === this.selectedCategory && c !== 'all') opt.selected = true;
                    select.appendChild(opt);
                });
                document.getElementById('modalAddList').classList.add('active');
            },
            
            // --- NEW ADMIN FUNCTIONS ---
            showDataModal() {
                document.getElementById('modalData').classList.add('active');
                const exportObj = {
                    categories: this.customCategories,
                    lists: this.wordLists.filter(l => l.category !== 'P1 Hong Kong') // Only export user lists
                };
                document.getElementById('exportJsonOutput').value = JSON.stringify(exportObj, null, 2);
            },
            
            switchTab(tabId, btn) {
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(tabId).classList.add('active');
                btn.classList.add('active');
            },

            processBulkImport() {
                const text = document.getElementById('bulkTextInput').value;
                if (!text.trim()) return;

                const lines = text.split('\n');
                let currentCat = "Imported";
                let currentList = null;
                let listsCreated = 0;
                let newLists = [];
                let catsToAdd = new Set();

                lines.forEach(line => {
                    line = line.trim();
                    if (!line) return;

                    if (line.startsWith('##')) {
                        const listName = line.substring(2).trim();
                        currentList = {
                            id: Date.now() + Math.random().toString(), 
                            name: listName,
                            category: currentCat,
                            words: []
                        };
                        newLists.push(currentList);
                        listsCreated++;
                    } else if (line.startsWith('#')) {
                        currentCat = line.substring(1).trim();
                        catsToAdd.add(currentCat);
                        currentList = null; 
                    } else {
                        if (currentList) {
                            const [en, hint] = line.split(/,|Ôºå/);
                            if (en) {
                                currentList.words.push({ 
                                    en: en.trim(), 
                                    hint: hint ? hint.trim() : en.trim() 
                                });
                            }
                        }
                    }
                });

                if (listsCreated > 0) {
                    catsToAdd.forEach(c => {
                        if (!this.customCategories.includes(c)) this.customCategories.push(c);
                    });
                    const validLists = newLists.filter(l => l.words.length > 0);
                    this.wordLists = [...this.wordLists, ...validLists];
                    
                    this.saveData();
                    this.renderHome();
                    alert(`Successfully imported ${validLists.length} lists!`);
                    this.closeModals();
                    document.getElementById('bulkTextInput').value = '';
                } else {
                    alert('No valid lists found. Use # for Category and ## for List Name.');
                }
            },

            copyExportData() {
                const copyText = document.getElementById("exportJsonOutput");
                copyText.select();
                copyText.setSelectionRange(0, 99999); 
                navigator.clipboard.writeText(copyText.value).then(() => {
                    alert("Data copied to clipboard!");
                });
            },

            processJsonImport() {
                const jsonStr = document.getElementById('importJsonInput').value;
                try {
                    const data = JSON.parse(jsonStr);
                    let importedCount = 0;

                    if (data.categories && Array.isArray(data.categories)) {
                        data.categories.forEach(c => {
                            if (!this.customCategories.includes(c)) this.customCategories.push(c);
                        });
                    }

                    if (data.lists && Array.isArray(data.lists)) {
                        data.lists.forEach(l => {
                            if (l.name && l.words && l.words.length > 0) {
                                l.id = Date.now() + Math.random().toString(); 
                                this.wordLists.push(l);
                                importedCount++;
                            }
                        });
                    }

                    if (importedCount > 0) {
                        this.saveData();
                        this.renderHome();
                        alert(`Successfully restored ${importedCount} lists!`);
                        this.closeModals();
                        document.getElementById('importJsonInput').value = '';
                    } else {
                        alert('No valid lists found in JSON.');
                    }

                } catch (e) {
                    alert('Invalid JSON data.');
                }
            },

            closeModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active')); },
            
            handleCreateCategory(e) {
                e.preventDefault();
                const name = document.getElementById('inputCatName').value.trim();
                if (name && !this.customCategories.includes(name)) {
                    this.customCategories.push(name);
                    this.saveData();
                    this.selectedCategory = name;
                    this.renderHome();
                }
                this.closeModals();
                document.getElementById('inputCatName').value = '';
            },
            handleCreateList(e) {
                e.preventDefault();
                const name = document.getElementById('inputListName').value.trim();
                const cat = document.getElementById('inputListCategory').value;
                const rawWords = document.getElementById('inputListWords').value;
                if (!name || !cat) return;
                const parsedWords = rawWords.split('\n').map(line => {
                    const [en, hint] = line.split(/,|Ôºå/);
                    return { en: en ? en.trim() : '', hint: hint ? hint.trim() : (en ? en.trim() : '') };
                }).filter(w => w.en.length > 0);
                if (parsedWords.length === 0) { alert('Please add at least one word'); return; }
                this.wordLists.push({ id: Date.now().toString(), name: name, category: cat, words: parsedWords });
                this.saveData();
                this.selectedCategory = cat;
                this.renderHome();
                this.closeModals();
                document.getElementById('inputListName').value = '';
                document.getElementById('inputListWords').value = '';
            }
        };

    // Init App
    app.init();
</script>

<script>
  // --- Simple CEDICT connectivity test ---
  (async () => {
    try {
      const res = await fetch('./cedict_ts.txt');
      if (!res.ok) {
        console.log('CEDICT not reachable:', res.status);
        return;
      }
      const text = await res.text();
      console.log('CEDICT loaded, length =', text.length);
    } catch (e) {
      console.error('Error loading cedict_ts.txt', e);
    }
  })();
</script>

</body>
</html>
